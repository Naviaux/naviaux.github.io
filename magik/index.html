<!-- var myWindow = window.open("", "", "width=200,height=100"); -->

<html>
	<head>
		<title>Mageiks</title>
		<style>html, body {
	padding: 0;
	margin: 0;
	background-color: #ddd;
	overflow: hidden;
	font-family: sans-serif;
	font-weight: bold;
}

#enemy {
	width: 100%;
}
#enemyHealth {
	background-color: #cc3a5f;
	text-align: center;
	color: #f7f3ef;
	padding: 3px;
}

#player {
	width: 100%;
	position: absolute;
	bottom: 0;
}
#player > div {
	width: 100%;
}

#playerHealth {
	background-color: #cc3a5f;
	text-align: center;
	color: #f7f3ef;
	height: 1em;
	padding: 3px;
}
#playerMana {
	background-color: #3333dd;
	text-align: center;
	color: #f7f3ef;
	height: 1em;
	padding: 3px;
}

#playerSpells {
	display: table;
}

#playerSpells div {
	display: table-cell;
	height: 25vh;
	max-width: 25vw;
	text-align: center;
	vertical-align: middle;
	background-color: #ede4cc;
	margin: 0;
	border: 3px outset #e3e3ff;
}
#playerSpells div:hover {
	cursor: pointer;
	background-color: #edffcc;
}

.spellInfo {
	text-align: center;
	font-size: 8px;
	font-weight: initial;
	vertical-align: bottom;
}

#menu {
	position: relative;
	height: 100%;
	display: table;
}

#menu_options div {
	user-select: none;
	display: block;
	width: 100%;
	background-color: rgba(0,0,0,0.01);
	padding: 4px;
}
#menu_options div:hover {
	background-color: #edffcc;
	cursor: pointer;
}

.btn {
	display: table-cell;
	text-align: center;
	background-color: #ede4cc;
	border: 3px outset #e3e3ff;
}
.btn:hover {
	cursor: pointer;
	background-color: #edffcc;
}
#spells { cursor: not-allowed; background-color: #3d3d3d; border: 3px solid #e3e3ff; color: #e3e3ff; }</style>
		<link rel="stylesheet" type="text/css" href="mage.css" />
		<script src="http://code.jquery.com/jquery-3.4.1.js"></script>
		<script src="./mage.js">/*Mechanics:
	After spending x mana, increase mana by y amount
	Researching and Constructing stops the caster from interacting with enemies
	Researching is used to discover new elements, constructs, and upgrades.
	Constructs are used for various things; from storing mana to increasing research speed to killing enemies
	Constructs take damage prior to the caster
*/
var IDLE = 0;
var FIGHTING = 1;
var RESEARCHING = 2;
var CONSTRUCTING = 3;

var game = {}
game.player = {};
game.player.currentAction = IDLE;
game.player.currentResearch = "";
game.player.safetyNet = 20;
game.player.stats = {}
game.player.stats.hp = {};
game.player.stats.hp.current = 100;
game.player.stats.hp.max = 100;
game.player.stats.mana = {};
game.player.stats.mana.current = 100;
game.player.stats.mana.max = 100;
game.player.stats.mana.increaseAmount = 1;
game.player.stats.mana.increaseRequired = 1000;
game.player.stats.mana.increaseCounter = 0;
game.player.stats.mana.regenFlat = 1;
game.player.stats.mana.regenMax = 0;
game.player.stats.mana.regenCurrent = 0;
game.player.stats.mana.regenDelay = 5; // 1 tick = 500ms
game.player.stats.mana.regenCounter = 0;
game.player.stats.research = {};
game.player.stats.research.progress = 1;
game.player.stats.research.progressMultiplier = 1;
game.player.stats.research.speed = 1; // unused
game.player.stats.research.delay = 0; // unused
game.player.stats.construction = {};
game.player.stats.construction.progress = 1;
game.player.stats.construction.progressMultiplier = 1;
game.player.stats.construction.speed = 20;
game.player.stats.construction.delay = 0;
game.player.spells = [
	{
		attributes : ["arcana"]
	}
];
game.player.magics = {};
game.player.magics.arcana = {};
game.player.magics.arcana.primaryDamage = 5;
game.player.magics.arcana.primaryCost = 20;
game.player.magics.arcana.secondaryDamage = 1.4;
game.player.magics.arcana.secondaryCost = 0.9;

game.research = {
	"Mana Conduit" : {
		count: 0,
		researchProgress: 0,
		researchTime: 1,
		scopes : () => { return [ 
			game.research["Mana Conduit"],
			game.player.stats.mana
		]},
		effects : [
			[1, (u) => { u.scopes[1].increaseAmount += u.value } ],
			[1.2, (u) => { u.scopes[0].effects[0][0] *= u.value } ],
			[2.5, (u) => { u.scopes[0].researchTime *= u.value } ]
		]
	},
	"Mana Control" : {
		count: 0,
		max : 500,
		researchProgress: 0,
		researchTime: 1,
		scopes : () => { return [
			game.research["Mana Control"],
			game.player.stats.mana
		]},
		effects : [
			[1, (u) => { u.scopes[1].increaseRequired -= u.value } ],
			[2.5, (u) => { u.scopes[0].researchTime *= u.value } ]
		],
	},
	"Cyclic Breathing" : {
		count: 0,
		researchProgress: 0,
		researchTime: 1,
		scopes : () => { return [
			game.research["Cyclic Breathing"],
			game.player.stats.mana
		]},
		effects : [
			[1, (u) => { u.scopes[1].regenFlat += u.value } ],
			[1.15, (u) => { u.scopes[0].effects[0][0] *= u.value } ],
			[1.66, (u) => { u.scopes[0].researchTime *= u.value } ],
			[1.005, (u) => { u.scopes[0].effects[2][0] *= u.value } ]
		]
	},
	"Meditation" : {
		count: 0,
		max : 200,
		researchProgress: 0,
		researchTime: 1,
		scopes : () => { return [
			game.research["Meditation"],
			game.player.stats.mana
		]},
		effects : [
			[0.001, (u) => { u.scopes[1].regenMax += u.value } ],
			[2.5, (u) => { u.scopes[0].researchTime *= u.value } ]
		],
		requirements : [
			() => { return game.player.stats.mana.max >= 500}
		],
	},
	"Reflux" : {
		count: 0,
		researchProgress: 0,
		researchTime: 1,
		scopes : () => { return [
			game.research["Reflux"],
			game.player.stats.mana
		]},
		effects : [
			[0.05, (u) => { u.scopes[1].regenCurrent += u.value } ],
			[2.5, (u) => { u.scopes[0].researchTime *= u.value } ]
		],
		requirements : [
			() => { return game.player.stats.mana.max >= 10000 },
			() => { return game.research["Meditation"].count > 50 }
		],
		max : 10
	},
	"Arcana Specialization" : {
		count : 0,
		researchProgress: 0,
		researchTime: 1,
		scopes : () => { return [
			game.research["Arcana Specialization"],
			game.player.magics.arcana
		]},
		effects : [
			[5, (u) => { u.scopes[1].primaryDamage += u.value } ],
			[5, (u) => { u.scopes[1].primaryCost += u.value } ],
			[1.05, (u) => { u.scopes[0].effects[0][0] *= u.value } ],
			[1.025, (u) => { u.scopes[0].effects[1][0] *= u.value } ],
			[2.5, (u) => { u.scopes[0].researchTime *= u.value } ]
		],
	}
}
game.construct = {
	"Librarian" : {
		count : 0,
		max : 100,
		constructionTime : 1,
		constructionProgress : 0,
		scopes : () => { return [
			game.player.stats.mana,
			game.player.stats.research
		]},
		constructionCosts : [
			(c) => { return [ c[0].max, 1000, c[0].max >= 1000 + game.player.safetyNet, (x) => { x.scopes[0].max -= x.value} ] }
		],
		effects : [
			[0.1, (u) => { u.scopes[0].progressMultiplier += u.value }]
		]
	},
	"Scholar" : {
		count : 0,
		constructionTime : 10,
		constructionProgress : 0,
		scopes : () => { return [
			game.player.stats.mana,
			game.player.stats.research
		]},
		constructionCosts : [
			(c) => { return [ c[0].max, 100, c[0].max >= 100 + game.player.safetyNet, (x) => { x.scopes[0].max -= x.value } ] }
		],
		effects : [
			[1, (u) => { u.scopes[1].progress += u.value } ]
		]
	}
}

function startConstruction (construction) {
	var c = game.construct[construction];
	if (c.count >= c.max)
		return false;
	
	for (var cost in c.constructionCosts)
		if (!c.constructionCosts[cost](c.scopes())[2])
			return false;
	for (var cost in c.constructionCosts) {
		var scopes = c.scopes();
		var cc = c.constructionCosts[cost]
		cc(scopes)[3]( {	scopes : scopes	 ,	value : cc(scopes)[1]	} );
	}
	return true;
}

function onConstruct (construction) {
	var c = game.construct[construction];
	if (c.count >= c.max)
		return false;
	
	c.count++;
	var u = {
		level : c.count,
		value : 0,
		scopes : c.scopes()
	}
	for (var effect in c.effects) {
		u.value = c.effects[effect][0];
		c.effects[effect][1](u);
	}
}

function onUpgrade (upgrade) {
	var r = game.research[upgrade];
	if (r.count >= r.max)
		return false;
	
	r.count++;
	var u = {
		level : r.count,
		value : 0,
		scopes : r.scopes()
	}
	for (var effect in r.effects) {
		u.value = r.effects[effect][0];
		r.effects[effect][1](u);
	}
}
/*
researches = {
	Mana Conduit : Increase amount of mana gained for future mana increases
	Mana Control : Decrease amount of mana required to increase mana
	Cyclic Breathing : Increase flat mana recovery
	Meditation : Increase max percentage mana recovery
	Reflux : Increase current percentage mana recovery
	
	Arcane : Innate Research
		Upgrades: Damage and Cost
}

constructs = {
	Mana Orb : Increases maximum stored mana
	Processing Construct : Decreases research speed
}*/</script>
		<script>
			$(document).ready ( function() {
			
				game.enemy = {};
				game.enemy.stats = {};
				game.enemy.stats.hp = {};
				game.enemy.stats.hp.current = 10;
				game.enemy.stats.hp.max = 10;
				game.enemy.attack = {};
				game.enemy.attack.speed = 25;
				game.enemy.attack.damage = 1;
				game.enemy.attack.delay = 0;
				
				game.mechanics = {}
				game.mechanics.tick = 0;
				game.mechanics.tick_rate = 100;
				game.mechanics.enemy_respawn_ticks = 0;
				game.mechanics.respawn_delay = 0;
				game.mechanics.refresh_delay = -1;
				
				game.player.activeTab = RESEARCHING;
				game.player.currentConstruction = false;
				
				$("#slot1").click(function () {
					var spellSlot = game.player.spells[0];
					var mana = game.player.stats.mana;
					var enemy = game.enemy.stats;
					
					game.player.currentAction = FIGHTING;
					
					var spell = calculateSpellAttributes(spellSlot.attributes);
					(game.player.safetyNet <= spell.cost) ? game.player.safetyNet = spell.cost : 0;
					
					if (mana.current >= spell.cost && enemy.hp.current > 0) {
						mana.increaseCounter += spell.cost;
						mana.current -= spell.cost;
						enemy.hp.current -= spell.damage;
					}
					update();
				});
				
				function calculateSpellAttributes(attributes) {
					var magics = game.player.magics;
					var damage = magics[attributes[0]].primaryDamage;
					var cost = magics[attributes[0]].primaryCost;
					
					return { damage : damage, cost : cost };
				};
				
				function update() {
					var enemy = game.enemy.stats;
					var enemy_attack = game.enemy.attack;
					var player = game.player.stats;
					var mechanics = game.mechanics;
					mechanics.tick++;
					
					if (enemy.hp.current <= 0) {
						enemy.hp.current = 0;
						mechanics.respawn_delay++;
						if (mechanics.respawn_delay >= mechanics.enemy_respawn_ticks) {
							enemy.hp.current = enemy.hp.max;
							enemy_attack.delay = 0;
							mechanics.respawn_delay = 0;
						}
					} else {
						enemy_attack.delay++;
						if (game.player.currentAction == FIGHTING) {
							if (enemy_attack.delay >= enemy_attack.speed) {
								player.hp.current -= enemy_attack.damage;
								enemy_attack.delay = 0;
							}
						} else {
							enemy_attack.delay += enemy_attack.speed;
						}
					}
					
					if (player.mana.current > player.mana.max)
						player.mana.current = player.mana.max;
					
					if (player.mana.increaseCounter >= player.mana.increaseRequired) {
						player.mana.max += player.mana.increaseAmount;
						player.mana.increaseCounter = 0;
					}
					
					player.mana.regenCounter++;
					if (player.mana.regenCounter >= player.mana.regenDelay && game.player.currentAction != CONSTRUCTING) {
						player.mana.current += player.mana.regenFlat;
						player.mana.current += player.mana.max * player.mana.regenMax;
						player.mana.regenCounter = 0;
						if (player.mana.current >= player.mana.max) {
							player.mana.current = player.mana.max;
						}
					}
					
					if (game.player.currentAction == RESEARCHING) {
						game.research[game.player.currentResearch].researchProgress += player.research.progress * player.research.progressMultiplier;
						if (game.research[game.player.currentResearch].researchProgress >= game.research[game.player.currentResearch].researchTime) {
							onUpgrade(game.player.currentResearch);
							game.player.currentAction = IDLE;
							game.research[game.player.currentResearch].researchProgress = 0;
							game.mechanics.refresh_delay = -1;
						}
					}
					if (game.player.currentAction == CONSTRUCTING) {
						player.construction.delay++;
						if (player.construction.delay >= player.construction.speed) {
							game.construct[game.player.currentConstruction].constructionProgress += player.construction.progress * player.construction.progressMultiplier;
							player.construction.delay = 0;
						}
						if (game.player.currentConstruction && game.construct[game.player.currentConstruction].constructionProgress >= game.construct[game.player.currentConstruction].constructionTime) {
							onConstruct (game.player.currentConstruction);
							game.construct[game.player.currentConstruction].constructionProgress = 0;
							game.player.currentAction = IDLE;
							game.player.currentConstruction = false;
							game.mechanics.refresh_delay = -1;
						}
					} else {
						player.construction.delay = 0;
					}
					
					if (game.player.activeTab != CONSTRUCTING && ((game.mechanics.refresh_delay % 4) == 0 || game.player.currentAction == RESEARCHING) || (game.mechanics.refresh_delay == -1 && game.player.activeTab == RESEARCHING)) {
						$("#menu_options").html( () => {
							var research = game.research;
							var toAdd = "";
							for (var r in research) {
								var hasReqs = true;
								for (var reqs in research[r].requirements) {
									if (!research[r].requirements[reqs]()) {
										hasReqs = false;
										break;
									}
								}
								if (hasReqs && !(research[r].count >= research[r].max)) {
									toAdd += '<div id="' + r.replace(/ /g, "_") + '">' + r + ' ' + research[r].count + ' ' + research[r].researchProgress + '/' + Math.ceil(research[r].researchTime) + '</div>';
								}
							}
							return toAdd;
						});
						$("#slot1 .spellInfo").html( () => {
							var spellSlot = game.player.spells[0];
							var spell = calculateSpellAttributes(spellSlot.attributes);
							return Math.floor(spell.damage) + " damage<br>" + Math.floor(spell.cost) + " mana";
						});
						$("#menu_options div").click( function(e) {
							game.player.currentResearch = e.currentTarget.id.replace(/_/g, " ");
							game.player.currentAction = RESEARCHING;
						});
						game.mechanics.refresh_delay = 1;
					} else if (game.player.activeTab == CONSTRUCTING && game.mechanics.refresh_delay % 4 == 0  || game.mechanics.refresh_delay == -1) {
						$("#menu_options").html( () => {
							var construct = game.construct;
							var toAdd = "";
							for (var c in construct) {
								var hasReqs = true;
								for (var reqs in construct[c].requirements) {
									if (!construct[c].requirements[reqs]()) {
										hasReqs = false;
										break;
									}
								}
								if (hasReqs && !(construct[c].count >= construct[c].max)) {
									toAdd += '<div id="' + c.replace(/ /g, "_") + '">' + c + ' ' + construct[c].count + ' ' + construct[c].constructionProgress + '/' + Math.ceil(construct[c].constructionTime) + '</div>';
								}
							}
							return toAdd;
						});
						$("#menu_options div").click( function(e) {
							var con = e.currentTarget.id.replace(/_/g, " ");
							if (!game.player.currentConstruction && startConstruction(con)) {
								game.player.currentConstruction = con;
								game.player.currentAction = CONSTRUCTING;
							} else if (game.player.currentConstruction) {
								game.player.currentAction = CONSTRUCTING;
							}
						});
						game.mechanics.refresh_delay = 1;
					} else {
						game.mechanics.refresh_delay++;
					}
					
					
					$("#enemyHealth").html(Math.floor(enemy.hp.current) + "/" + enemy.hp.max);
					$("#playerHealth").html(Math.floor(player.hp.current) + "/" + player.hp.max);
					$("#playerMana").html(Math.floor(player.mana.current) + "/" + Math.floor(player.mana.max) + " (+" + Math.floor(player.mana.regenFlat + (player.mana.max * player.mana.regenMax) + (player.mana.current * player.mana.regenCurrent)) + ")" );
				
						
				}
				$(".btn").click( function (e) {
					game.player.activeTab = e.currentTarget.id == "CONSTRUCTING" ? CONSTRUCTING : RESEARCHING;
				});
				
				
				setInterval(update, game.mechanics.tick_rate);
			});
		</script>
		<style>
			#cast {
				display:inline-block;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id = "enemy">
			<div id = "enemyHealth">
				5/5
			</div>
		</div>
		<div id = "player">
			<div id = "menu_options"></div>
			<div id = "menu">
				<div id = "RESEARCHING" class="btn">R</div>
				<div id = "spells" class="btn">NYI</div>
				<div id = "CONSTRUCTING" class="btn">C</div>
			</div>
			<div id = "playerHealth">
				100/100
			</div>
			<div id = "playerMana">
				100/100
			</div>
			<div id = "playerSpells">
				<div id = "slot1">
					1<br>
					<span class="spellInfo">5 Damage<br>20 Mana</span>
				</div>
				<div id = "slot2">
					2<br>
					<span class="spellInfo">None</span>
				</div>
				<div id = "slot3">
					3<br>
					<span class="spellInfo">None</span>
				</div>
				<div id = "slot4">
					4<br>
					<span class="spellInfo">None</span>
				</div>
			</div>
		</div>
	</body>
</html>
